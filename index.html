<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Matches</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<button id="matchbtn" onclick="toggleMatches()">Active Matches</button>

<div id="matches-container">
    <!-- Matches will be rendered here -->
</div>

<script>
    // Dummy implementations for user/item info functions -- replace with real API calls or data
    function getUserThumbnail(user_id) {
        // Return a placeholder or construct URL dynamically
        return "./img/user-placeholder.png";
    }

    function getName(user_id) {
        // Replace with real name lookup or data
        return "User " + user_id;
    }

    function getItemInfo(item_id) {
        // Replace with real item info lookup
        return { item_image: "./img/item-placeholder.png" };
    }

    // Global variables to track selection for matches
    let value = 0;
    let minval = 0;
    let maxval = 0;
    let items = [];
    let publicmatches = true;
    let gamesavail = true;

    async function fetchSession() {
        // Dummy session fetch - replace with real API call
        // For example: return fetch('/api/session').then(res => res.json());
        return { user_id: 1 };  // example logged in user
    }

    async function fetchMatches(user_id) {
        // Dummy matches fetch - replace with real API call
        // For example: return fetch('/api/matches?user_id=' + user_id).then(res => res.json());
        return [
            {
                game_id: 101,
                starter_id: 1,
                starter_side: 0,
                starter_items: JSON.stringify([{item_id: 11}, {item_id: 12}]),
                starter_value: 50,
                player_id: 2,
                player_items: JSON.stringify([{item_id: 21}]),
                player_value: 55,
                end_date: null,
                winner_side: null
            },
            {
                game_id: 102,
                starter_id: 3,
                starter_side: 1,
                starter_items: JSON.stringify([{item_id: 31}]),
                starter_value: 30,
                player_id: 4,
                player_items: JSON.stringify([{item_id: 41}, {item_id: 42}]),
                player_value: 32,
                end_date: "2025-01-01T10:00:00Z",
                winner_side: 0
            }
        ];
    }

    function renderMatch(match, session) {
        const isStarter = match.starter_id === session?.user_id;
        const isEnded = !!match.end_date;

        let buttonsHtml = '';
        if (!isEnded) {
            if (!session) {
                buttonsHtml = `<button onclick="login()" class="btn-primary">Join Match (${match.starter_value - 10} - ${match.starter_value + 10})</button>`;
            } else if (!isStarter) {
                buttonsHtml = `<button onclick="joinMatch(${match.game_id}, ${match.starter_value})" class="btn-primary">Join Match (${match.starter_value - 10} - ${match.starter_value + 10})</button>`;
            } else {
                buttonsHtml = `<button onclick="cancelMatch(${match.game_id})" class="btn-primary">Cancel Match</button>`;
            }
        }

        const starterItems = JSON.parse(match.starter_items || '[]').map(item => 
            `<img src="${getItemInfo(item.item_id).item_image}" width="32" height="32" loading="lazy" />`
        ).join('');

        const playerItems = JSON.parse(match.player_items || '[]').map(item =>
            `<img src="${getItemInfo(item.item_id).item_image}" width="32" height="32" loading="lazy" />`
        ).join('');

        const winnerImg = match.winner_side === 0 ? "./img/gem.png" : "./img/dog.png";

        return `
        <div class="match" id="game${match.game_id}" style="border:1px solid #ccc; padding:10px; margin:10px 0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <img src="${match.starter_side === 0 ? "./img/gem.png" : "./img/dog.png"}" alt="Starter side" width="32" height="32" loading="lazy" />
                    <img src="${getUserThumbnail(match.starter_id)}" alt="Starter user" width="32" height="32" loading="lazy" />
                    <span style="font-size:18px; font-weight:bold;">${getName(match.starter_id)}</span>
                    ${starterItems}
                </div>
                <div>
                    ${isEnded ? `<span style="font-size:16px;">Value: ${match.starter_value}</span>` : ''}
                    ${buttonsHtml}
                </div>
            </div>

            <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <img src="${match.starter_side === 1 ? "./img/gem.png" : "./img/dog.png"}" alt="Player side" width="32" height="32" loading="lazy" />
                    ${isEnded ? `
                    <img src="${getUserThumbnail(match.player_id)}" alt="Player user" width="32" height="32" loading="lazy" />
                    <span style="font-size:18px; font-weight:bold;">${getName(match.player_id)}</span>
                    ${playerItems}
                    ` : ''}
                </div>
                <div style="font-size:16px;">
                    ${isEnded ? `Value: ${match.player_value}` : ''}
                </div>
            </div>

            <div style="margin-top:15px; text-align:center;">
                ${!isEnded ? `
                    <h2>Value <br />${match.starter_value}</h2>
                    <div style="color:cadetblue;">(${Math.max(match.starter_value - 10, 10)} - ${match.starter_value + 10})</div>
                ` : `
                    <div class="coin ${match.winner_side === 0 ? "red" : "blue"}" style="display:flex; justify-content:center; gap:20px; margin-bottom:10px;">
                        <div class="blue">
                            <img src="./img/dog.png" loading="lazy" width="50" height="50" />
                        </div>
                        <div class="red">
                            <img src="./img/gem.png" loading="lazy" width="50" height="50" />
                        </div>
                    </div>
                    <img style="border-radius:50%;" class="hidden" src="${winnerImg}" width="80" height="80" loading="lazy" />
                `}
            </div>
        </div>`;
    }

    async function renderMatches() {
        const session = await fetchSession();
        const matches = await fetchMatches(session?.user_id);

        const container = document.getElementById('matches-container');
        container.innerHTML = matches.map(match => renderMatch(match, session)).join('');
    }

    // Your existing JS functions converted for client-side usage:

    function login() {
        alert("Please log in!");
        // Or redirect to login page
    }

    function toggleMatches() {
        const btn = document.getElementById("matchbtn");
        btn.textContent = btn.textContent === "Active Matches" ? "My Matches" : "Active Matches";
        // This would toggle visibility of public vs my matches if implemented
    }

    function cancelMatch(game_id) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You are about to cancel this game!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
            if (result.isConfirmed) {
                cancelMatchOK(game_id);
            }
        });
    }

    function cancelMatchOK(game_id) {
        Swal.fire({
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        // AJAX call to cancel match
        $.ajax({
            url: "./php/game",
            type: "POST",
            data: {
                type: "cancel",
                game_id: game_id
            },
            success: function(data) {
                data = JSON.parse(data);
                Swal.close();
                if (data.Error) {
                    Swal.fire("Error", data.Error, "error");
                } else {
                    Swal.fire({
                        title: 'Cancel Successful',
                        text: 'Game has been Successfully Cancelled',
                        icon: 'success'
                    }).then(() => location.reload());
                }
            }
        });
    }

    function joinMatch(game_id, val) {
        value = 0;
        minval = val - 10;
        if (minval < 10) minval = 10;
        maxval = val + 10;
        items = [];
        togglePopup('selitem');
        $("#valheader").text("(Value must be between " + minval + " and " + maxval + ")");
        $("#valdiv").text("Value: 0");
        $("#okbtn").attr("onclick", "joinMatchconf(" + game_id + ")");
        $("#okbtn").text("Join Match");
        $("#okbtn").attr("disabled", true);
        $(".selectionbtn").each(function() {
            $(this).removeClass("btn-primary").addClass("btn-secondary").text("Select");
        });
    }

    function joinMatchconf(game_id) {
        togglePopup('selitem');
        Swal.fire({
            title: 'Are you sure?',
            text: "You are about to join this game!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, join it!'
        }).then((result) => {
            if (result.isConfirmed) {
                joinMatchOK(game_id, items);
            }
        });
    }

    function joinMatchOK(game_id, items) {
        Swal.fire({
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        $.ajax({
            url: "./php/game",
            type: "POST",
            data: {
                type: "play",
                game_id: game_id,
                item_ids: JSON.stringify(items)
            },
            success: function(data) {
                data = JSON.parse(data);
                Swal.close();
                if (data.Error) {
                    Swal.fire("Error", data.Error, "error");
                } else {
                    Swal.fire("Success", "You joined the match!", "success").then(() => location.reload());
                }
            }
        });
    }

    // Popup toggler placeholder
    function togglePopup(id) {
        // Implement popup toggle here or use a modal library
        alert("Popup '" + id + "' would open here.");
    }

    // Run render on page load
    document.addEventListener("DOMContentLoaded", () => {
        renderMatches();
    });
</script>

</body>
</html>
